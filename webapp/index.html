<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geez Bingo - Card Selection</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .wallet-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .card-number {
            background: white;
            border-radius: 10px;
            padding: 15px 5px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .card-number:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card-number.selected {
            border-color: #4CAF50;
            background: #E8F5E8;
        }

        .card-number.unavailable {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-btn {
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .page-info {
            color: white;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #333;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .bingo-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .bingo-card.show {
            display: block;
        }

        .bingo-header {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            background: #333;
            color: white;
            border-radius: 5px;
            padding: 5px;
        }

        .bingo-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            margin-bottom: 5px;
        }

        .bingo-cell {
            padding: 10px 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 2px;
        }

        .bingo-cell.free {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }

        .bingo-cell.marked {
            background: #FFEB3B;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Geez Bingo</h1>
            <p>Select Your Bingo Card</p>
        </div>

        <div class="wallet-info">
            <div>Your Wallet</div>
            <div class="wallet-amount" id="walletAmount">0</div>
            <div>Stake: <span id="stakeAmount">10</span> coins</div>
        </div>

        <div class="search-box">
            <input type="number" class="search-input" id="cardSearch" placeholder="Enter card number (145-544)" min="145" max="544">
        </div>

        <div class="pagination">
            <button class="page-btn" id="prevPage">‚¨ÖÔ∏è Previous</button>
            <span class="page-info" id="pageInfo">Page 1/10</span>
            <button class="page-btn" id="nextPage">Next ‚û°Ô∏è</button>
        </div>

        <div class="card-grid" id="cardGrid">
            <!-- Cards will be dynamically inserted here -->
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" id="randomCard">üé≤ Random Card</button>
            <button class="btn btn-primary" id="selectCard" disabled>‚úÖ Select Card</button>
        </div>

        <div class="bingo-card" id="bingoCardPreview">
            <div class="bingo-header">
                <div>B</div>
                <div>I</div>
                <div>N</div>
                <div>G</div>
                <div>O</div>
            </div>
            <!-- Bingo card rows will be dynamically inserted here -->
        </div>

        <div class="loading" id="loading">
            Loading available cards...
        </div>
    </div>

    <script>
        class BingoWebApp {
            constructor() {
                this.tg = window.Telegram.WebApp;
                this.selectedCard = null;
                this.currentPage = 0;
                this.cardsPerPage = 40;
                this.availableCards = [];
                this.userData = {};
                this.gameData = {};

                this.init();
            }

            async init() {
                // Expand the Web App to full screen
                this.tg.expand();

                // Get initial data from Telegram
                const initData = this.tg.initData || '';
                const initDataUnsafe = this.tg.initDataUnsafe || {};
                
                console.log('Init Data:', initDataUnsafe);

                // Try to get user data from init data or wait for it to be sent
                if (initDataUnsafe.user) {
                    this.userData = initDataUnsafe.user;
                    await this.loadGameData();
                } else {
                    // Request user data from bot
                    this.tg.ready();
                    this.setupEventListeners();
                    this.showLoading('Connecting to bot...');
                }

                this.setupEventListeners();
            }

            async loadGameData() {
                try {
                    this.showLoading('Loading game data...');
                    
                    // In a real implementation, you would fetch this from your bot's API
                    // For now, we'll simulate the data
                    await this.simulateGameData();
                    
                    this.hideLoading();
                    this.renderCardGrid();
                    this.updateWalletDisplay();
                    
                } catch (error) {
                    console.error('Error loading game data:', error);
                    this.showLoading('Error loading data. Please try again.');
                }
            }

            async simulateGameData() {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Simulated game data - in real implementation, this comes from your bot
                this.gameData = {
                    wallet: 162,
                    stake: 10,
                    availableCards: Array.from({length: 400}, (_, i) => i + 145).filter(() => Math.random() > 0.3), // 70% available
                    currentGame: {
                        id: 1,
                        active: false,
                        pot: 0
                    }
                };

                this.availableCards = this.gameData.availableCards;
            }

            setupEventListeners() {
                // Pagination
                document.getElementById('prevPage').addEventListener('click', () => this.previousPage());
                document.getElementById('nextPage').addEventListener('click', () => this.nextPage());

                // Card selection
                document.getElementById('randomCard').addEventListener('click', () => this.selectRandomCard());
                document.getElementById('selectCard').addEventListener('click', () => this.confirmCardSelection());

                // Search
                document.getElementById('cardSearch').addEventListener('input', (e) => this.handleSearch(e));
                document.getElementById('cardSearch').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleSearchEnter(e);
                    }
                });

                // Telegram Web App events
                this.tg.onEvent('viewportChanged', this.onViewportChanged.bind(this));
                
                // Listen for messages from the bot
                this.tg.onEvent('message', this.handleBotMessage.bind(this));
            }

            renderCardGrid() {
                const grid = document.getElementById('cardGrid');
                grid.innerHTML = '';

                const startIndex = this.currentPage * this.cardsPerPage;
                const endIndex = startIndex + this.cardsPerPage;
                const pageCards = this.availableCards.slice(startIndex, endIndex);

                // Generate all possible card numbers for this page range
                const startCard = 145 + (this.currentPage * this.cardsPerPage);
                const endCard = Math.min(startCard + this.cardsPerPage - 1, 544);

                for (let cardNum = startCard; cardNum <= endCard; cardNum++) {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card-number';
                    cardElement.textContent = cardNum;
                    cardElement.dataset.cardNumber = cardNum;

                    if (!this.availableCards.includes(cardNum)) {
                        cardElement.classList.add('unavailable');
                    } else {
                        cardElement.addEventListener('click', () => this.selectCard(cardNum));
                    }

                    grid.appendChild(cardElement);
                }

                this.updatePagination();
            }

            selectCard(cardNumber) {
                // Deselect previous card
                document.querySelectorAll('.card-number.selected').forEach(card => {
                    card.classList.remove('selected');
                });

                // Select new card
                const cardElement = document.querySelector(`[data-card-number="${cardNumber}"]`);
                if (cardElement) {
                    cardElement.classList.add('selected');
                }

                this.selectedCard = cardNumber;
                document.getElementById('selectCard').disabled = false;

                // Show card preview
                this.showCardPreview(cardNumber);
            }

            selectRandomCard() {
                const available = this.availableCards.filter(card => 
                    card >= 145 + (this.currentPage * this.cardsPerPage) && 
                    card < 145 + ((this.currentPage + 1) * this.cardsPerPage)
                );

                if (available.length > 0) {
                    const randomCard = available[Math.floor(Math.random() * available.length)];
                    this.selectCard(randomCard);
                } else {
                    alert('No available cards on this page. Try another page.');
                }
            }

            async confirmCardSelection() {
                if (!this.selectedCard) return;

                if (this.gameData.wallet < this.gameData.stake) {
                    alert('Insufficient funds in your wallet!');
                    return;
                }

                try {
                    this.showLoading('Joining game...');

                    // Send selection back to bot
                    const selectionData = {
                        action: 'select_card',
                        card_number: this.selectedCard,
                        user_id: this.userData?.id,
                        timestamp: Date.now()
                    };

                    // Send data to bot
                    if (this.tg.sendData) {
                        this.tg.sendData(JSON.stringify(selectionData));
                    }

                    // Show success message
                    this.showSuccess(`Card #${this.selectedCard} selected successfully!`);

                    // Close the web app after a delay
                    setTimeout(() => {
                        this.tg.close();
                    }, 2000);

                } catch (error) {
                    console.error('Error selecting card:', error);
                    alert('Error selecting card. Please try again.');
                }
            }

            showCardPreview(cardNumber) {
                const preview = document.getElementById('bingoCardPreview');
                preview.classList.add('show');

                // Generate bingo card based on card number (deterministic)
                const card = this.generateBingoCard(cardNumber);
                this.renderBingoCard(card);
            }

            generateBingoCard(seed) {
                // Use seed to generate deterministic card
                const rng = this.seededRandom(seed);
                const card = { B: [], I: [], N: [], G: [], O: [] };
                const ranges = {
                    'B': [1, 15],
                    'I': [16, 30],
                    'N': [31, 45],
                    'G': [46, 60],
                    'O': [61, 75]
                };

                for (const [letter, [min, max]] of Object.entries(ranges)) {
                    const numbers = [];
                    while (numbers.length < 5) {
                        const num = Math.floor(rng() * (max - min + 1)) + min;
                        if (!numbers.includes(num)) {
                            numbers.push(num);
                        }
                    }
                    card[letter] = numbers;
                }

                // Center is free
                card['N'][2] = 'FREE';

                return card;
            }

            seededRandom(seed) {
                return function() {
                    seed = (seed * 9301 + 49297) % 233280;
                    return seed / 233280;
                };
            }

            renderBingoCard(card) {
                const container = document.getElementById('bingoCardPreview');
                let html = '<div class="bingo-header"><div>B</div><div>I</div><div>N</div><div>G</div><div>O</div></div>';

                for (let i = 0; i < 5; i++) {
                    html += '<div class="bingo-row">';
                    for (const letter of ['B', 'I', 'N', 'G', 'O']) {
                        const value = card[letter][i];
                        const cellClass = value === 'FREE' ? 'bingo-cell free' : 'bingo-cell';
                        html += `<div class="${cellClass}">${value}</div>`;
                    }
                    html += '</div>';
                }

                container.innerHTML = html;
            }

            previousPage() {
                if (this.currentPage > 0) {
                    this.currentPage--;
                    this.renderCardGrid();
                }
            }

            nextPage() {
                const totalPages = Math.ceil(this.availableCards.length / this.cardsPerPage);
                if (this.currentPage < totalPages - 1) {
                    this.currentPage++;
                    this.renderCardGrid();
                }
            }

            updatePagination() {
                const totalPages = Math.ceil(this.availableCards.length / this.cardsPerPage);
                document.getElementById('pageInfo').textContent = `Page ${this.currentPage + 1}/${totalPages}`;
                document.getElementById('prevPage').disabled = this.currentPage === 0;
                document.getElementById('nextPage').disabled = this.currentPage >= totalPages - 1;
            }

            handleSearch(e) {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    const cardNum = parseInt(searchTerm);
                    if (cardNum >= 145 && cardNum <= 544) {
                        // Find which page this card would be on
                        const page = Math.floor((cardNum - 145) / this.cardsPerPage);
                        if (page !== this.currentPage) {
                            this.currentPage = page;
                            this.renderCardGrid();
                        }
                        
                        // Highlight the card
                        const cardElement = document.querySelector(`[data-card-number="${cardNum}"]`);
                        if (cardElement) {
                            cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            cardElement.style.animation = 'pulse 1s infinite';
                            setTimeout(() => {
                                cardElement.style.animation = '';
                            }, 2000);
                        }
                    }
                }
            }

            handleSearchEnter(e) {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    const cardNum = parseInt(searchTerm);
                    if (cardNum >= 145 && cardNum <= 544 && this.availableCards.includes(cardNum)) {
                        this.selectCard(cardNum);
                    }
                }
            }

            updateWalletDisplay() {
                document.getElementById('walletAmount').textContent = this.gameData.wallet;
                document.getElementById('stakeAmount').textContent = this.gameData.stake;
            }

            showLoading(message) {
                const loading = document.getElementById('loading');
                loading.textContent = message;
                loading.style.display = 'block';
                
                document.getElementById('cardGrid').style.display = 'none';
                document.getElementById('bingoCardPreview').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('cardGrid').style.display = 'grid';
                document.getElementById('bingoCardPreview').style.display = 'block';
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #4CAF50;
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    z-index: 1000;
                    text-align: center;
                `;
                successDiv.textContent = message;
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 3000);
            }

            onViewportChanged() {
                console.log('Viewport changed');
            }

            handleBotMessage(message) {
                console.log('Message from bot:', message);
                // Handle messages from the bot if needed
            }
        }

        // Initialize the web app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new BingoWebApp();
        });

        // Add some CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            .card-number {
                animation-duration: 0.3s;
                animation-fill-mode: both;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
